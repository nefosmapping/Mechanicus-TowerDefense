<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40K: Последний бой | KrimProduction & Огузок™</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Orbitron', 'Arial', sans-serif;
            user-select: none;
        }

        body {
            background: #000;
            overflow: hidden;
            color: #fff;
            width: 100vw;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Заставка */
        #splash-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0033 0%, #000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s;
        }

        .splash-title {
            font-size: 4em;
            color: #fff;
            text-shadow: 0 0 30px #9d00ff, 0 0 60px #9d00ff;
            letter-spacing: 0.3em;
            margin-bottom: 30px;
            animation: pulse 3s infinite;
            font-weight: 900;
        }

        .splash-subtitle {
            font-size: 1.5em;
            color: #ccc;
            opacity: 0.8;
            animation: fadeIn 3s ease-out;
            margin-bottom: 50px;
        }

        .splash-tm {
            position: absolute;
            bottom: 40px;
            right: 40px;
            font-size: 1em;
            color: #9d00ff;
            opacity: 0.6;
        }

        /* Кат-сцена */
        #cut-scene {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 900;
        }

        .cutscene-content {
            width: 90%;
            max-width: 800px;
            background: rgba(26, 0, 51, 0.9);
            border: 3px solid #9d00ff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 100px rgba(157, 0, 255, 0.5);
        }

        .commander-card {
            display: flex;
            margin-bottom: 30px;
            border: 2px solid #9d00ff;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(74, 0, 109, 0.5);
        }

        .commander-image {
            width: 200px;
            height: 250px;
            background: linear-gradient(45deg, #1a0033, #4a006d);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            color: #9d00ff;
        }

        .commander-info {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .commander-name {
            font-size: 2em;
            color: #9d00ff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #9d00ff;
        }

        .commander-title {
            font-size: 1.2em;
            color: #00ffff;
            margin-bottom: 15px;
        }

        .dialogue-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #00ffff;
        }

        .typing-indicator {
            width: 100%;
            height: 2px;
            background: #9d00ff;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .typing-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: typing 2s infinite;
        }

        .skip-btn {
            background: linear-gradient(45deg, #9d00ff, #4a006d);
            border: none;
            color: white;
            padding: 10px 30px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            float: right;
            transition: all 0.3s;
        }

        .skip-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #9d00ff;
        }

        /* Игровой экран */
        #game-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 800;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #game-canvas:active {
            cursor: grabbing;
        }

        /* Игровой интерфейс */
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 700;
        }

        .top-bar {
            position: absolute;
            top: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(26, 0, 51, 0.9) 0%, transparent 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            pointer-events: all;
        }

        .resources {
            display: flex;
            gap: 30px;
            font-size: 1.2em;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #9d00ff;
        }

        .resource-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }

        .credits-icon { background: linear-gradient(45deg, gold, #ffd700); color: #000; }
        .power-icon { background: linear-gradient(45deg, #00ffff, #0088ff); color: #000; }
        .requisition-icon { background: linear-gradient(45deg, #ff4500, #ff8800); color: #000; }

        .wave-info {
            font-size: 1.2em;
            color: #ff4500;
            text-shadow: 0 0 15px #ff4500;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #ff4500;
        }

        /* Панель юнитов */
        .unit-palette {
            position: absolute;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(26, 0, 51, 0.8);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #9d00ff;
            backdrop-filter: blur(5px);
            pointer-events: all;
        }

        .unit-card {
            width: 100px;
            height: 120px;
            background: linear-gradient(45deg, #2a0044, #4a006d);
            border: 2px solid #9d00ff;
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .unit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(157, 0, 255, 0.5);
            background: linear-gradient(45deg, #4a006d, #9d00ff);
        }

        .unit-icon {
            width: 40px;
            height: 40px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ffff;
        }

        .unit-cost {
            color: gold;
            font-size: 1em;
            font-weight: bold;
        }

        .unit-name {
            color: #fff;
            font-size: 0.8em;
            text-align: center;
        }

        .dragging {
            opacity: 0.7;
            transform: scale(1.1);
            z-index: 1000;
        }

        .selected {
            border-color: #00ff00 !important;
            box-shadow: 0 0 15px #00ff00 !important;
        }

        /* Индикатор размещения */
        .drop-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px dashed #00ff00;
            border-radius: 50%;
            pointer-events: none;
            z-index: 600;
            display: none;
            animation: pulse 1s infinite;
        }

        /* Экран поражения */
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border-radius: 20px;
            border: 5px solid #ff4500;
            text-align: center;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 100px rgba(255, 69, 0, 0.5);
            backdrop-filter: blur(10px);
            min-width: 400px;
        }

        .game-over-title {
            font-size: 3em;
            color: #ff4500;
            text-shadow: 0 0 20px #ff4500;
            margin-bottom: 20px;
        }

        .stats {
            font-size: 1.3em;
            color: #fff;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ff4500, #ff8800);
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 69, 0, 0.8);
        }

        /* Загрузчик */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
            z-index: 1100;
        }

        .loader-text {
            font-size: 1.5em;
            color: #9d00ff;
            margin-bottom: 20px;
        }

        .loader-progress-container {
            width: 400px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid #9d00ff;
        }

        .loader-progress {
            height: 100%;
            background: linear-gradient(90deg, #9d00ff, #00ffff);
            width: 0%;
            transition: width 0.3s;
        }

        .loader-percent {
            font-size: 1.2em;
            color: #00ffff;
            font-weight: bold;
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 0, 51, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #9d00ff;
            font-size: 0.9em;
            color: #ccc;
            pointer-events: none;
        }

        /* Анимации */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes typing {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Информационная панель */
        .info-panel {
            position: absolute;
            right: 20px;
            top: 80px;
            width: 250px;
            background: rgba(26, 0, 51, 0.9);
            border: 2px solid #9d00ff;
            border-radius: 10px;
            padding: 20px;
            pointer-events: all;
            backdrop-filter: blur(5px);
        }

        .info-title {
            color: #9d00ff;
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-text {
            color: #ccc;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .mine-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(74, 0, 109, 0.3);
            border-radius: 5px;
        }

        .mine-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(157, 0, 255, 0.3);
        }

        .mine-name {
            color: #fff;
            font-size: 0.9em;
        }

        .mine-value {
            color: #00ff00;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Основной контейнер -->
    <div id="game-container">
        <!-- Заставка -->
        <div id="splash-screen">
            <div class="splash-title">KRIMPRODUCTION</div>
            <div class="splash-subtitle">совместно с Огузок™</div>
            <div class="splash-tm">Warhammer 40 000 Universe</div>
        </div>

        <!-- Упрощенная кат-сцена -->
        <div id="cut-scene">
            <div class="cutscene-content">
                <div class="commander-card">
                    <div class="commander-image">
                        ⚙
                    </div>
                    <div class="commander-info">
                        <div class="commander-name">КОМАНДИР ЛЕКСУС</div>
                        <div class="commander-title">Адептус Механикус, Когорт VII</div>
                        <div class="commander-title">Командир корабля "Омниссия Прайм"</div>
                    </div>
                </div>
                
                <div id="dialogue-text" class="dialogue-text">
                    Вы - командир судна Адептус Механикус, дитя великой Омниссии. К большому сожалению, ваш корабль потерпел крушение на далёкой планете Доминика, населённой орками. И видимо, это будет ваш последний бой. Сражайтесь достойно, во имя Императора.<br><br>
                    Во мрачной тьме далёкого будущего есть только война...
                </div>
                
                <div class="typing-indicator"></div>
                <button class="skip-btn" id="skip-btn">ПРОПУСТИТЬ</button>
            </div>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen">
            <canvas id="game-canvas"></canvas>
            
            <!-- Игровой интерфейс -->
            <div id="game-ui">
                <div class="top-bar">
                    <div class="resources">
                        <div class="resource">
                            <div class="resource-icon credits-icon">Ⱡ</div>
                            <span id="credits">2000</span>
                        </div>
                        <div class="resource">
                            <div class="resource-icon power-icon">⚡</div>
                            <span id="power">300/300</span>
                        </div>
                        <div class="resource">
                            <div class="resource-icon requisition-icon">⚙</div>
                            <span id="requisition">0/мин</span>
                        </div>
                    </div>
                    <div class="wave-info">
                        <div>ВОЛНА: <span id="wave">1</span></div>
                        <div>До следующей: <span id="wave-timer">30</span>с</div>
                    </div>
                </div>

                <div class="unit-palette" id="unit-palette">
                    <div class="unit-card" data-unit="skitarii" draggable="true">
                        <div class="unit-icon">⚔</div>
                        <div class="unit-name">Скитарий</div>
                        <div class="unit-cost">250 Ⱡ</div>
                    </div>
                    <div class="unit-card" data-unit="turret" draggable="true">
                        <div class="unit-icon">☢</div>
                        <div class="unit-name">Турель</div>
                        <div class="unit-cost">500 Ⱡ</div>
                    </div>
                    <div class="unit-card" data-unit="dreadnought" draggable="true">
                        <div class="unit-icon">⚙</div>
                        <div class="unit-name">Дредноут</div>
                        <div class="unit-cost">1000 Ⱡ</div>
                    </div>
                </div>

                <!-- Информационная панель -->
                <div class="info-panel">
                    <div class="info-title">СТРАТЕГИЧЕСКИЙ ДИСПЛЕЙ</div>
                    <div class="info-text">• Перетаскивайте юнитов на поле</div>
                    <div class="info-text">• Кликните юнита для выбора</div>
                    <div class="info-text">• Кликните на карту для перемещения</div>
                    <div class="info-text">• Удерживайте шахты для дохода</div>
                    
                    <div class="mine-status">
                        <div class="mine-item">
                            <span class="mine-name">Шахта Альфа</span>
                            <span class="mine-value" id="mine-1">Свободна</span>
                        </div>
                        <div class="mine-item">
                            <span class="mine-name">Шахта Бета</span>
                            <span class="mine-value" id="mine-2">Свободна</span>
                        </div>
                        <div class="mine-item">
                            <span class="mine-name">Шахта Гамма</span>
                            <span class="mine-value" id="mine-3">Свободна</span>
                        </div>
                    </div>
                    
                    <div class="info-text" style="color: #ff4500; margin-top: 10px;">
                        База: <span id="base-hp">1000</span> HP
                    </div>
                </div>

                <!-- Индикатор размещения -->
                <div class="drop-indicator" id="drop-indicator"></div>

                <!-- Подсказки по управлению -->
                <div class="controls-hint">
                    Управление камерой: WASD / Стрелки<br>
                    Вращение камеры: Зажать колесо мыши + двигать<br>
                    Перемещение юнитов: Выбрать + клик на карту
                </div>
            </div>
        </div>

        <!-- Экран поражения -->
        <div class="game-over" id="game-over">
            <div class="game-over-title">ПОРАЖЕНИЕ</div>
            <div class="stats">
                Вы продержались <span id="survived-waves">0</span> волн<br>
                Уничтожено врагов: <span id="enemies-killed">0</span><br>
                Добыто ресурсов: <span id="resources-earned">0</span> Ⱡ
            </div>
            <button class="restart-btn" id="restart-btn">НАЧАТЬ ЗАНОВО</button>
        </div>

        <!-- Загрузчик -->
        <div class="loader" id="loader">
            <div class="loader-text" id="loader-text">ИНИЦИАЛИЗАЦИЯ СИСТЕМ</div>
            <div class="loader-progress-container">
                <div class="loader-progress" id="loader-progress"></div>
            </div>
            <div class="loader-percent" id="loader-percent">0%</div>
        </div>
    </div>

    <!-- Подключаем Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Основной игровой код -->
    <script>
        // ==================== МЕНЕДЖЕР ЗАГРУЗКИ ====================
        class LoadManager {
            constructor() {
                this.progress = 0;
                this.totalAssets = 10;
                this.loadedAssets = 0;
            }

            show() {
                document.getElementById('loader').style.display = 'block';
            }

            hide() {
                document.getElementById('loader').style.display = 'none';
            }

            updateProgress() {
                this.loadedAssets++;
                this.progress = Math.min(100, Math.round((this.loadedAssets / this.totalAssets) * 100));
                document.getElementById('loader-progress').style.width = this.progress + '%';
                document.getElementById('loader-percent').textContent = this.progress + '%';
            }

            async load(description) {
                document.getElementById('loader-text').textContent = description;
                this.updateProgress();
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
            }
        }

        // ==================== ЗАСТАВКА ====================
        class SplashScreen {
            static show() {
                return new Promise(resolve => {
                    const splash = document.getElementById('splash-screen');
                    splash.style.display = 'flex';
                    
                    setTimeout(() => {
                        splash.style.opacity = '0';
                        setTimeout(() => {
                            splash.style.display = 'none';
                            splash.style.opacity = '1';
                            resolve();
                        }, 1000);
                    }, 2000);
                });
            }
        }

        // ==================== КАТ-СЦЕНА ====================
        class Cutscene {
            constructor() {
                this.dialogueText = document.getElementById('dialogue-text');
                this.fullText = this.dialogueText.innerHTML;
                this.dialogueText.innerHTML = '';
                this.currentIndex = 0;
                this.isTyping = false;
                this.skipped = false;
                this.typingSpeed = 30;
                this.resolvePromise = null;
            }

            show() {
                return new Promise(resolve => {
                    this.resolvePromise = resolve;
                    document.getElementById('cut-scene').style.display = 'flex';
                    this.startTyping();
                    
                    // Добавляем обработчик для кнопки пропуска
                    document.getElementById('skip-btn').addEventListener('click', () => this.skip());
                });
            }

            startTyping() {
                this.isTyping = true;
                this.typeWriter();
            }

            typeWriter() {
                if (this.skipped || this.currentIndex >= this.fullText.length) {
                    this.isTyping = false;
                    setTimeout(() => {
                        this.hide();
                        if (this.resolvePromise) this.resolvePromise();
                    }, 1500);
                    return;
                }

                this.dialogueText.innerHTML = this.fullText.substring(0, this.currentIndex + 1);
                this.currentIndex++;

                setTimeout(() => this.typeWriter(), this.typingSpeed);
            }

            skip() {
                if (this.isTyping) {
                    this.skipped = true;
                    this.dialogueText.innerHTML = this.fullText;
                } else {
                    this.hide();
                    if (this.resolvePromise) this.resolvePromise();
                }
            }

            hide() {
                const cutScene = document.getElementById('cut-scene');
                cutScene.style.opacity = '0';
                setTimeout(() => {
                    cutScene.style.display = 'none';
                    cutScene.style.opacity = '1';
                }, 500);
            }
        }

        // ==================== ОСНОВНАЯ ИГРА ====================
        class Game {
            constructor() {
                this.loader = new LoadManager();
                this.cutscene = null;
                this.gameState = null;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                this.keys = {};
                this.mouseButtons = {};
                this.cameraTarget = new THREE.Vector3(0, 50, 80);
                this.cameraRotation = { x: -Math.PI / 6, y: 0 };
                this.isRotating = false;
                this.lastMousePosition = { x: 0, y: 0 };
                this.selectedUnit = null;
                this.draggedUnit = null;
                
                this.gameLoopId = null;
                this.waveInterval = null;
                this.economyInterval = null;
                this.waveTimerInterval = null;
                
                this.unitMeshes = new Map();
            }

            static async start() {
                const game = new Game();
                await game.init();
                window.Game = game;
            }

            static restart() {
                if (window.Game) {
                    window.Game.cleanup();
                }
                location.reload();
            }

            cleanup() {
                if (this.gameLoopId) {
                    cancelAnimationFrame(this.gameLoopId);
                }
                if (this.waveInterval) clearInterval(this.waveInterval);
                if (this.economyInterval) clearInterval(this.economyInterval);
                if (this.waveTimerInterval) clearInterval(this.waveTimerInterval);
                
                // Удаляем обработчики событий
                const skipBtn = document.getElementById('skip-btn');
                const restartBtn = document.getElementById('restart-btn');
                if (skipBtn) {
                    skipBtn.replaceWith(skipBtn.cloneNode(true));
                }
                if (restartBtn) {
                    restartBtn.replaceWith(restartBtn.cloneNode(true));
                }
                
                if (this.renderer) {
                    this.renderer.dispose();
                }
            }

            async init() {
                try {
                    console.log('Шаг 1: Заставка');
                    await SplashScreen.show();
                    
                    console.log('Шаг 2: Загрузчик');
                    this.loader.show();
                    
                    console.log('Шаг 3: Проверка Three.js');
                    if (typeof THREE === 'undefined') {
                        throw new Error('Three.js не загружен');
                    }
                    
                    console.log('Шаг 4: Инициализация Three.js');
                    await this.loader.load("Загрузка графического движка...");
                    await this.initThreeJS();
                    
                    console.log('Шаг 5: Инициализация игровых систем');
                    await this.loader.load("Настройка игровых систем...");
                    await this.initGameSystems();
                    
                    console.log('Шаг 6: Создание игрового мира');
                    await this.loader.load("Создание игрового мира...");
                    await this.createGameWorld();
                    
                    console.log('Шаг 7: Инициализация интерфейса');
                    await this.loader.load("Инициализация интерфейса...");
                    await this.initUI();
                    
                    console.log('Шаг 8: Финальная подготовка');
                    await this.loader.load("Финальная подготовка...");
                    
                    console.log('Шаг 9: Создание кат-сцены');
                    this.cutscene = new Cutscene();
                    
                    console.log('Шаг 10: Загрузка завершена');
                    this.loader.hide();
                    
                    console.log('Шаг 11: Кат-сцена');
                    await this.cutscene.show();
                    
                    console.log('Шаг 12: Запуск игры');
                    await this.startGameplay();
                    
                } catch (error) {
                    console.error('Ошибка загрузки:', error);
                    this.loader.hide();
                    this.showErrorMessage('Произошла ошибка при загрузке игры. Пожалуйста, обновите страницу.');
                }
            }

            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.position = 'absolute';
                errorDiv.style.top = '50%';
                errorDiv.style.left = '50%';
                errorDiv.style.transform = 'translate(-50%, -50%)';
                errorDiv.style.background = 'rgba(0,0,0,0.9)';
                errorDiv.style.color = '#ff4500';
                errorDiv.style.padding = '30px';
                errorDiv.style.borderRadius = '10px';
                errorDiv.style.border = '2px solid #ff4500';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.zIndex = '2000';
                errorDiv.innerHTML = `
                    <h2 style="margin-bottom: 20px;">ОШИБКА</h2>
                    <p style="margin-bottom: 20px;">${message}</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(45deg, #ff4500, #ff8800);
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        cursor: pointer;
                        border-radius: 5px;
                    ">ОБНОВИТЬ СТРАНИЦУ</button>
                `;
                document.getElementById('game-container').appendChild(errorDiv);
            }

            async initThreeJS() {
                return new Promise((resolve) => {
                    try {
                        // Создаем сцену
                        this.scene = new THREE.Scene();
                        this.scene.background = new THREE.Color(0x000000);
                        
                        // Создаем камеру
                        this.camera = new THREE.PerspectiveCamera(
                            60,
                            window.innerWidth / window.innerHeight,
                            0.1,
                            1000
                        );
                        this.camera.position.set(0, 50, 80);
                        this.camera.lookAt(0, 0, 0);
                        
                        // Создаем рендерер
                        const canvas = document.getElementById('game-canvas');
                        this.renderer = new THREE.WebGLRenderer({
                            canvas: canvas,
                            antialias: true
                        });
                        this.renderer.setSize(window.innerWidth, window.innerHeight);
                        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                        this.renderer.shadowMap.enabled = true;
                        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                        
                        // Освещение
                        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                        this.scene.add(ambientLight);
                        
                        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                        directionalLight.position.set(100, 200, 100);
                        directionalLight.castShadow = true;
                        this.scene.add(directionalLight);
                        
                        // Обработка ресайза
                        window.addEventListener('resize', () => this.onWindowResize());
                        
                        resolve();
                    } catch (error) {
                        console.error('Ошибка инициализации Three.js:', error);
                        throw error;
                    }
                });
            }

            async initGameSystems() {
                return new Promise((resolve) => {
                    this.gameState = {
                        credits: 2000,
                        power: 300,
                        powerMax: 300,
                        requisition: 0,
                        currentWave: 1,
                        waveTimer: 30,
                        baseHP: 1000,
                        baseMaxHP: 1000,
                        enemiesKilled: 0,
                        resourcesEarned: 0,
                        controlledMines: 0,
                        totalMines: 3,
                        mineIncome: 50,
                        gameTime: 0,
                        gameActive: false,
                        units: [],
                        enemies: [],
                        mines: [],
                        selectedUnit: null
                    };
                    
                    this.unitsData = {
                        skitarii: { 
                            cost: 250, 
                            hp: 150, 
                            damage: 30, 
                            range: 40, 
                            attackSpeed: 1.0,
                            color: 0x9d00ff,
                            movable: true 
                        },
                        turret: { 
                            cost: 500, 
                            hp: 300, 
                            damage: 50, 
                            range: 60, 
                            attackSpeed: 0.8,
                            color: 0xffd700,
                            movable: false 
                        },
                        dreadnought: { 
                            cost: 1000, 
                            hp: 800, 
                            damage: 80, 
                            range: 25, 
                            attackSpeed: 1.5,
                            color: 0xff4500,
                            movable: true 
                        }
                    };
                    
                    resolve();
                });
            }

            async createGameWorld() {
                return new Promise((resolve) => {
                    // Земля
                    const groundGeometry = new THREE.CircleGeometry(300, 64);
                    const groundMaterial = new THREE.MeshStandardMaterial({
                        color: 0x1a1a2e,
                        roughness: 0.8,
                        metalness: 0.2
                    });
                    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                    ground.rotation.x = -Math.PI / 2;
                    ground.receiveShadow = true;
                    this.scene.add(ground);
                    
                    // База
                    this.createBase();
                    
                    // Шахты
                    this.createMines();
                    
                    // Декорации
                    this.createDecorations();
                    
                    resolve();
                });
            }

            createBase() {
                const baseGroup = new THREE.Group();
                
                // Основная башня
                const towerGeometry = new THREE.CylinderGeometry(15, 20, 30, 16);
                const towerMaterial = new THREE.MeshStandardMaterial({
                    color: 0x333333,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const tower = new THREE.Mesh(towerGeometry, towerMaterial);
                tower.position.y = 15;
                tower.castShadow = true;
                baseGroup.add(tower);
                
                // Энергетическое ядро
                const coreGeometry = new THREE.SphereGeometry(6, 16, 16);
                const coreMaterial = new THREE.MeshStandardMaterial({
                    color: 0x00ffff,
                    emissive: 0x00ffff,
                    emissiveIntensity: 0.5,
                    transparent: true,
                    opacity: 0.8
                });
                this.core = new THREE.Mesh(coreGeometry, coreMaterial);
                this.core.position.y = 15;
                baseGroup.add(this.core);
                
                // Платформа
                const platformGeometry = new THREE.CylinderGeometry(25, 30, 4, 16);
                const platformMaterial = new THREE.MeshStandardMaterial({
                    color: 0x444444,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                platform.position.y = 2;
                baseGroup.add(platform);
                
                this.scene.add(baseGroup);
                this.baseObject = baseGroup;
            }

            createMines() {
                const minePositions = [
                    { x: 100, z: 0, name: "Альфа" },
                    { x: -50, z: 86, name: "Бета" },
                    { x: -86, z: -50, name: "Гамма" }
                ];

                minePositions.forEach((pos, index) => {
                    const mineGroup = new THREE.Group();
                    
                    // Платформа
                    const platformGeometry = new THREE.CylinderGeometry(10, 12, 3, 8);
                    const platformMaterial = new THREE.MeshStandardMaterial({
                        color: 0x333333,
                        metalness: 0.7,
                        roughness: 0.3
                    });
                    const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                    platform.position.y = 1.5;
                    platform.castShadow = true;
                    mineGroup.add(platform);
                    
                    // Буровая установка
                    const drillGeometry = new THREE.CylinderGeometry(3, 2, 15, 8);
                    const drillMaterial = new THREE.MeshStandardMaterial({
                        color: 0xff4500,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const drill = new THREE.Mesh(drillGeometry, drillMaterial);
                    drill.position.y = 8;
                    mineGroup.add(drill);
                    
                    mineGroup.position.set(pos.x, 0, pos.z);
                    this.scene.add(mineGroup);
                    
                    const mine = {
                        id: index,
                        group: mineGroup,
                        drill: drill,
                        x: pos.x,
                        z: pos.z,
                        name: pos.name,
                        controlled: false,
                        income: 50
                    };
                    
                    this.gameState.mines.push(mine);
                });
            }

            createDecorations() {
                // Камни
                for (let i = 0; i < 20; i++) {
                    const size = 2 + Math.random() * 8;
                    const rockGeometry = new THREE.DodecahedronGeometry(size, 0);
                    const rockMaterial = new THREE.MeshStandardMaterial({
                        color: 0x333333,
                        roughness: 0.8
                    });
                    const rock = new THREE.Mesh(rockGeometry, rockMaterial);
                    
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 80 + Math.random() * 200;
                    rock.position.x = Math.cos(angle) * distance;
                    rock.position.z = Math.sin(angle) * distance;
                    rock.position.y = size / 2;
                    
                    rock.castShadow = true;
                    this.scene.add(rock);
                }
            }

            async initUI() {
                return new Promise((resolve) => {
                    // Перетаскивание юнитов
                    const unitCards = document.querySelectorAll('.unit-card');
                    unitCards.forEach(card => {
                        card.addEventListener('dragstart', (e) => this.handleDragStart(e));
                        card.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    });
                    
                    // Обработчик для кнопки рестарта
                    document.getElementById('restart-btn').addEventListener('click', () => Game.restart());
                    
                    // Настройка управления
                    this.setupControls();
                    
                    resolve();
                });
            }

            setupControls() {
                // Клавиатура
                window.addEventListener('keydown', (e) => {
                    if (!this.gameState?.gameActive) return;
                    this.keys[e.key.toLowerCase()] = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    if (!this.gameState?.gameActive) return;
                    this.keys[e.key.toLowerCase()] = false;
                });
                
                // Мышь
                const canvas = document.getElementById('game-canvas');
                
                canvas.addEventListener('mousedown', (e) => {
                    if (!this.gameState?.gameActive) return;
                    
                    if (e.button === 1) { // Средняя кнопка
                        this.isRotating = true;
                        this.lastMousePosition.x = e.clientX;
                        this.lastMousePosition.y = e.clientY;
                        canvas.style.cursor = 'grabbing';
                    }
                    this.mouseButtons[e.button] = true;
                    
                    // Выбор юнита
                    if (e.button === 0 && !this.draggedUnit) {
                        this.handleCanvasClick(e);
                    }
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    if (!this.gameState?.gameActive) return;
                    
                    if (this.isRotating) {
                        const deltaX = e.clientX - this.lastMousePosition.x;
                        const deltaY = e.clientY - this.lastMousePosition.y;
                        
                        this.cameraRotation.y += deltaX * 0.005;
                        this.cameraRotation.x += deltaY * 0.005;
                        this.cameraRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.cameraRotation.x));
                        
                        this.lastMousePosition.x = e.clientX;
                        this.lastMousePosition.y = e.clientY;
                    }
                    
                    // Индикатор перетаскивания
                    if (this.draggedUnit) {
                        const indicator = document.getElementById('drop-indicator');
                        indicator.style.left = (e.clientX - 20) + 'px';
                        indicator.style.top = (e.clientY - 20) + 'px';
                    }
                });
                
                canvas.addEventListener('mouseup', (e) => {
                    if (!this.gameState?.gameActive) return;
                    
                    if (e.button === 1) {
                        this.isRotating = false;
                        canvas.style.cursor = 'grab';
                    }
                    this.mouseButtons[e.button] = false;
                    
                    // Размещение юнита
                    if (e.button === 0 && this.draggedUnit) {
                        this.placeUnit(e);
                    }
                });
                
                canvas.addEventListener('wheel', (e) => {
                    if (!this.gameState?.gameActive) return;
                    e.preventDefault();
                    
                    const zoomSpeed = 3;
                    const delta = e.deltaY > 0 ? zoomSpeed : -zoomSpeed;
                    const newDistance = this.camera.position.distanceTo(new THREE.Vector3(0, 0, 0)) + delta;
                    
                    if (newDistance >= 30 && newDistance <= 200) {
                        const direction = this.camera.position.clone().normalize();
                        this.camera.position.copy(direction.multiplyScalar(newDistance));
                    }
                });
                
                canvas.addEventListener('contextmenu', (e) => {
                    if (!this.gameState?.gameActive) return;
                    e.preventDefault();
                    
                    // Перемещение юнита
                    if (this.selectedUnit && this.selectedUnit.userData?.movable) {
                        this.moveSelectedUnit(e);
                    }
                });
            }

            handleDragStart(e) {
                if (!this.gameState?.gameActive) return;
                
                this.draggedUnit = e.target.dataset.unit;
                const unitCost = this.unitsData[this.draggedUnit]?.cost || 0;
                
                if (this.gameState.credits < unitCost) {
                    alert('Недостаточно кредитов!');
                    e.preventDefault();
                    this.draggedUnit = null;
                    return;
                }
                
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', this.draggedUnit);
                
                const indicator = document.getElementById('drop-indicator');
                indicator.style.display = 'block';
                indicator.style.left = (e.clientX - 20) + 'px';
                indicator.style.top = (e.clientY - 20) + 'px';
            }

            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                const indicator = document.getElementById('drop-indicator');
                indicator.style.display = 'none';
                this.draggedUnit = null;
            }

            handleCanvasClick(e) {
                const rect = e.target.getBoundingClientRect();
                this.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                // Проверяем клик по юнитам
                const unitIntersects = this.raycaster.intersectObjects(this.gameState.units);
                if (unitIntersects.length > 0) {
                    this.selectUnit(unitIntersects[0].object);
                    return;
                }
                
                // Проверяем клик по шахтам
                const mineIntersects = this.raycaster.intersectObjects(
                    this.gameState.mines.map(m => m.group.children[0])
                );
                
                if (mineIntersects.length > 0) {
                    const mineObject = mineIntersects[0].object.parent;
                    const mine = this.gameState.mines.find(m => m.group === mineObject);
                    if (mine && !mine.controlled) {
                        this.captureMine(mine);
                    }
                }
                
                // Снимаем выделение
                if (this.selectedUnit) {
                    if (this.selectedUnit.material && this.selectedUnit.material.emissive) {
                        this.selectedUnit.material.emissive.setHex(0x000000);
                    }
                    this.selectedUnit = null;
                }
            }

            selectUnit(unit) {
                // Снимаем выделение с предыдущего
                if (this.selectedUnit) {
                    if (this.selectedUnit.material && this.selectedUnit.material.emissive) {
                        this.selectedUnit.material.emissive.setHex(0x000000);
                    }
                }
                
                // Выделяем новый
                this.selectedUnit = unit;
                if (unit.material && unit.material.emissive) {
                    unit.material.emissive.setHex(0x00ff00);
                    unit.material.emissiveIntensity = 0.3;
                }
            }

            placeUnit(e) {
                if (!this.draggedUnit || !this.gameState?.gameActive) return;
                
                const unitType = this.draggedUnit;
                const unitData = this.unitsData[unitType];
                if (!unitData) return;
                
                if (this.gameState.credits < unitData.cost) {
                    alert('Недостаточно кредитов!');
                    return;
                }
                
                // Получаем позицию на земле
                const rect = e.target.getBoundingClientRect();
                this.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                const intersectionPoint = new THREE.Vector3();
                
                if (this.raycaster.ray.intersectPlane(plane, intersectionPoint)) {
                    // Проверяем расстояние до базы
                    const distanceToBase = intersectionPoint.distanceTo(new THREE.Vector3(0, 0, 0));
                    
                    if (distanceToBase > 25) {
                        this.createUnit(unitType, intersectionPoint.x, intersectionPoint.z);
                        this.gameState.credits -= unitData.cost;
                        this.updateUI();
                    }
                }
                
                this.draggedUnit = null;
                document.getElementById('drop-indicator').style.display = 'none';
            }

            createUnit(type, x, z) {
                const unitData = this.unitsData[type];
                if (!unitData) return null;
                
                let geometry;
                switch(type) {
                    case 'skitarii':
                        geometry = new THREE.CylinderGeometry(2, 2, 5, 8);
                        break;
                    case 'turret':
                        geometry = new THREE.CylinderGeometry(3, 4, 6, 8);
                        break;
                    case 'dreadnought':
                        geometry = new THREE.BoxGeometry(4, 6, 4);
                        break;
                    default:
                        geometry = new THREE.BoxGeometry(3, 3, 3);
                }
                
                const material = new THREE.MeshStandardMaterial({
                    color: unitData.color,
                    metalness: 0.7,
                    roughness: 0.3
                });
                
                const unit = new THREE.Mesh(geometry, material);
                unit.position.set(x, 2, z);
                unit.castShadow = true;
                unit.receiveShadow = true;
                
                unit.userData = {
                    type: type,
                    hp: unitData.hp,
                    maxHP: unitData.hp,
                    damage: unitData.damage,
                    range: unitData.range,
                    attackSpeed: unitData.attackSpeed,
                    lastAttack: 0,
                    movable: unitData.movable,
                    target: null
                };
                
                this.scene.add(unit);
                this.gameState.units.push(unit);
                
                return unit;
            }

            captureMine(mine) {
                if (!this.gameState?.gameActive) return;
                
                // Проверяем наличие юнитов рядом
                const hasUnitsNearby = this.gameState.units.some(unit => {
                    const unitPos = unit.position;
                    const minePos = new THREE.Vector3(mine.x, 0, mine.z);
                    return unitPos.distanceTo(minePos) < 20;
                });
                
                if (!hasUnitsNearby) {
                    alert('Нет юнитов рядом с шахтой!');
                    return;
                }
                
                mine.controlled = true;
                this.gameState.controlledMines++;
                
                // Визуальные изменения
                if (mine.drill) {
                    mine.drill.material.color.setHex(0x00ff00);
                }
                
                // Обновление UI
                const mineElement = document.getElementById(`mine-${mine.id + 1}`);
                if (mineElement) {
                    mineElement.textContent = 'Контролируется';
                    mineElement.style.color = '#00ff00';
                }
                
                this.updateUI();
            }

            moveSelectedUnit(e) {
                if (!this.selectedUnit || !this.selectedUnit.userData?.movable) return;
                
                const rect = e.target.getBoundingClientRect();
                this.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                const intersectionPoint = new THREE.Vector3();
                
                if (this.raycaster.ray.intersectPlane(plane, intersectionPoint)) {
                    const distanceToBase = intersectionPoint.distanceTo(new THREE.Vector3(0, 0, 0));
                    
                    if (distanceToBase > 25) {
                        this.selectedUnit.position.x = intersectionPoint.x;
                        this.selectedUnit.position.z = intersectionPoint.z;
                    }
                }
            }

            async startGameplay() {
                return new Promise((resolve) => {
                    document.getElementById('game-screen').style.display = 'block';
                    this.gameState.gameActive = true;
                    
                    this.updateUI();
                    
                    this.startGameLoop();
                    this.startWaves();
                    this.startEconomy();
                    
                    resolve();
                });
            }

            startGameLoop() {
                const animate = () => {
                    if (!this.gameState?.gameActive) return;
                    
                    this.gameState.gameTime++;
                    
                    // Обновление камеры
                    this.updateCamera();
                    
                    // Обновление анимаций
                    this.updateAnimations();
                    
                    // Обновление врагов
                    this.updateEnemies();
                    
                    // Обновление юнитов
                    this.updateUnits();
                    
                    // Проверка поражения
                    if (this.gameState.baseHP <= 0) {
                        this.endGame();
                        return;
                    }
                    
                    // Рендер
                    this.renderer.render(this.scene, this.camera);
                    
                    this.gameLoopId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            updateCamera() {
                // Управление WASD
                const cameraSpeed = 0.5;
                const moveVector = new THREE.Vector3();
                
                if (this.keys['w'] || this.keys['arrowup']) moveVector.z -= 1;
                if (this.keys['s'] || this.keys['arrowdown']) moveVector.z += 1;
                if (this.keys['a'] || this.keys['arrowleft']) moveVector.x -= 1;
                if (this.keys['d'] || this.keys['arrowright']) moveVector.x += 1;
                
                if (moveVector.length() > 0) {
                    moveVector.normalize().multiplyScalar(cameraSpeed);
                    
                    // Учитываем вращение камеры
                    const angle = this.cameraRotation.y;
                    const cos = Math.cos(angle);
                    const sin = Math.sin(angle);
                    
                    const deltaX = moveVector.x * cos - moveVector.z * sin;
                    const deltaZ = moveVector.x * sin + moveVector.z * cos;
                    
                    this.camera.position.x += deltaX;
                    this.camera.position.z += deltaZ;
                }
                
                // Обновление позиции камеры на основе вращения
                const distance = 80;
                const cameraX = Math.sin(this.cameraRotation.y) * distance;
                const cameraZ = Math.cos(this.cameraRotation.y) * distance;
                const cameraY = 50 + Math.sin(this.cameraRotation.x) * distance;
                
                this.camera.position.x = cameraX;
                this.camera.position.y = cameraY;
                this.camera.position.z = cameraZ;
                
                this.camera.lookAt(0, 0, 0);
            }

            updateAnimations() {
                // Анимация ядра базы
                if (this.core) {
                    const pulse = Math.sin(this.gameState.gameTime * 0.05) * 0.1 + 0.9;
                    this.core.scale.setScalar(pulse);
                }
                
                // Анимация шахт
                this.gameState.mines.forEach(mine => {
                    if (mine.drill) {
                        mine.drill.rotation.y += 0.02;
                    }
                });
            }

            startWaves() {
                // Первая волна через 10 секунд
                setTimeout(() => this.spawnWave(), 10000);
                
                // Интервал волн
                this.waveInterval = setInterval(() => {
                    if (!this.gameState?.gameActive) return;
                    
                    this.gameState.currentWave++;
                    this.gameState.waveTimer = 60;
                    this.spawnWave();
                    
                }, 60000); // 60 секунд между волнами
                
                // Таймер волны
                this.waveTimerInterval = setInterval(() => {
                    if (!this.gameState?.gameActive) return;
                    
                    if (this.gameState.waveTimer > 0) {
                        this.gameState.waveTimer--;
                        document.getElementById('wave-timer').textContent = this.gameState.waveTimer;
                    }
                }, 1000);
            }

            spawnWave() {
                const enemyCount = 2 + Math.floor(this.gameState.currentWave * 1.2);
                
                for (let i = 0; i < enemyCount; i++) {
                    setTimeout(() => {
                        if (!this.gameState?.gameActive) return;
                        this.spawnEnemy();
                    }, i * 1000);
                }
                
                document.getElementById('wave').textContent = this.gameState.currentWave;
            }

            spawnEnemy() {
                const angle = Math.random() * Math.PI * 2;
                const distance = 280;
                const x = Math.cos(angle) * distance;
                const z = Math.sin(angle) * distance;
                
                const geometry = new THREE.BoxGeometry(3, 4, 3);
                const material = new THREE.MeshStandardMaterial({
                    color: 0x00ff00,
                    metalness: 0.5,
                    roughness: 0.5
                });
                
                const enemy = new THREE.Mesh(geometry, material);
                enemy.position.set(x, 2, z);
                enemy.castShadow = true;
                
                enemy.userData = {
                    hp: 100 + this.gameState.currentWave * 20,
                    maxHP: 100 + this.gameState.currentWave * 20,
                    damage: 20 + this.gameState.currentWave * 5,
                    speed: 0.5 + Math.random() * 0.3,
                    bounty: 50 + this.gameState.currentWave * 10
                };
                
                this.scene.add(enemy);
                this.gameState.enemies.push(enemy);
            }

            updateEnemies() {
                for (let i = this.gameState.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.gameState.enemies[i];
                    
                    if (enemy.userData.hp <= 0) {
                        // Уничтожение врага
                        this.gameState.credits += enemy.userData.bounty;
                        this.gameState.enemiesKilled++;
                        this.gameState.resourcesEarned += enemy.userData.bounty;
                        
                        this.scene.remove(enemy);
                        this.gameState.enemies.splice(i, 1);
                        this.updateUI();
                        continue;
                    }
                    
                    // Движение к базе
                    const dx = 0 - enemy.position.x;
                    const dz = 0 - enemy.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance > 15) {
                        enemy.position.x += (dx / distance) * enemy.userData.speed;
                        enemy.position.z += (dz / distance) * enemy.userData.speed;
                    } else {
                        // Атака базы
                        this.gameState.baseHP -= enemy.userData.damage;
                        enemy.userData.hp = 0;
                        
                        // Визуальный эффект
                        this.createDamageEffect(0, 15, 0);
                        this.updateUI();
                    }
                }
            }

            updateUnits() {
                for (let i = this.gameState.units.length - 1; i >= 0; i--) {
                    const unit = this.gameState.units[i];
                    
                    if (unit.userData.hp <= 0) {
                        this.scene.remove(unit);
                        this.gameState.units.splice(i, 1);
                        continue;
                    }
                    
                    // Поиск и атака врагов
                    this.unitAttack(unit);
                }
            }

            unitAttack(unit) {
                const currentTime = this.gameState.gameTime;
                const attackCooldown = 60 / unit.userData.attackSpeed;
                
                if (currentTime - unit.userData.lastAttack < attackCooldown) return;
                
                // Поиск ближайшего врага
                let nearestEnemy = null;
                let nearestDistance = unit.userData.range;
                
                this.gameState.enemies.forEach(enemy => {
                    const distance = unit.position.distanceTo(enemy.position);
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestEnemy = enemy;
                    }
                });
                
                if (nearestEnemy) {
                    nearestEnemy.userData.hp -= unit.userData.damage;
                    unit.userData.lastAttack = currentTime;
                    
                    // Визуальный эффект атаки
                    this.createAttackEffect(unit, nearestEnemy);
                }
            }

            createAttackEffect(attacker, target) {
                const geometry = new THREE.BufferGeometry().setFromPoints([
                    attacker.position.clone(),
                    target.position.clone()
                ]);
                
                const material = new THREE.LineBasicMaterial({
                    color: attacker.userData.type === 'turret' ? 0xffd700 : 0x00ffff,
                    transparent: true,
                    opacity: 0.6
                });
                
                const line = new THREE.Line(geometry, material);
                this.scene.add(line);
                
                setTimeout(() => this.scene.remove(line), 100);
            }

            createDamageEffect(x, y, z) {
                const geometry = new THREE.SphereGeometry(3, 8, 8);
                const material = new THREE.MeshBasicMaterial({
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.5,
                    wireframe: true
                });
                
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(x, y, z);
                this.scene.add(sphere);
                
                let scale = 1;
                const animate = () => {
                    scale += 0.1;
                    sphere.scale.setScalar(scale);
                    sphere.material.opacity -= 0.05;
                    
                    if (sphere.material.opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        this.scene.remove(sphere);
                    }
                };
                animate();
            }

            startEconomy() {
                this.economyInterval = setInterval(() => {
                    if (!this.gameState?.gameActive) return;
                    
                    // Доход от шахт
                    const income = this.gameState.controlledMines * this.gameState.mineIncome;
                    this.gameState.credits += income;
                    this.gameState.resourcesEarned += income;
                    
                    // Регенерация энергии
                    this.gameState.power = Math.min(
                        this.gameState.powerMax,
                        this.gameState.power + 5
                    );
                    
                    // Обновление UI
                    document.getElementById('requisition').textContent = 
                        `+${this.gameState.controlledMines * this.gameState.mineIncome}/мин`;
                    
                    this.updateUI();
                    
                }, 5000); // Каждые 5 секунд
            }

            updateUI() {
                document.getElementById('credits').textContent = this.gameState.credits;
                document.getElementById('power').textContent = 
                    `${this.gameState.power}/${this.gameState.powerMax}`;
                document.getElementById('base-hp').textContent = this.gameState.baseHP;
            }

            onWindowResize() {
                if (!this.camera || !this.renderer) return;
                
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            endGame() {
                this.gameState.gameActive = false;
                
                if (this.gameLoopId) {
                    cancelAnimationFrame(this.gameLoopId);
                    this.gameLoopId = null;
                }
                if (this.waveInterval) clearInterval(this.waveInterval);
                if (this.economyInterval) clearInterval(this.economyInterval);
                if (this.waveTimerInterval) clearInterval(this.waveTimerInterval);
                
                document.getElementById('survived-waves').textContent = this.gameState.currentWave;
                document.getElementById('enemies-killed').textContent = this.gameState.enemiesKilled;
                document.getElementById('resources-earned').textContent = this.gameState.resourcesEarned;
                
                document.getElementById('game-over').style.display = 'block';
            }
        }

        // Запуск игры при полной загрузке страницы
        window.addEventListener('load', () => {
            // Проверяем поддержку WebGL
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (!gl) {
                const errorDiv = document.createElement('div');
                errorDiv.style.position = 'absolute';
                errorDiv.style.top = '50%';
                errorDiv.style.left = '50%';
                errorDiv.style.transform = 'translate(-50%, -50%)';
                errorDiv.style.background = 'rgba(0,0,0,0.9)';
                errorDiv.style.color = '#ff4500';
                errorDiv.style.padding = '30px';
                errorDiv.style.borderRadius = '10px';
                errorDiv.style.border = '2px solid #ff4500';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.zIndex = '2000';
                errorDiv.innerHTML = `
                    <h2 style="margin-bottom: 20px;">ОШИБКА ВЕБ-ГРАФИКИ</h2>
                    <p style="margin-bottom: 20px;">Ваш браузер не поддерживает WebGL. Игра не может быть запущена.</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(45deg, #ff4500, #ff8800);
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        cursor: pointer;
                        border-radius: 5px;
                    ">ПОПРОБОВАТЬ СНОВА</button>
                `;
                document.getElementById('game-container').appendChild(errorDiv);
                return;
            }
            
            // Запускаем игру
            Game.start().catch(error => {
                console.error('Ошибка запуска игры:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.position = 'absolute';
                errorDiv.style.top = '50%';
                errorDiv.style.left = '50%';
                errorDiv.style.transform = 'translate(-50%, -50%)';
                errorDiv.style.background = 'rgba(0,0,0,0.9)';
                errorDiv.style.color = '#ff4500';
                errorDiv.style.padding = '30px';
                errorDiv.style.borderRadius = '10px';
                errorDiv.style.border = '2px solid #ff4500';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.zIndex = '2000';
                errorDiv.innerHTML = `
                    <h2 style="margin-bottom: 20px;">ОШИБКА ЗАГРУЗКИ</h2>
                    <p style="margin-bottom: 20px;">Не удалось загрузить игру. Пожалуйста, обновите страницу.</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(45deg, #ff4500, #ff8800);
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        cursor: pointer;
                        border-radius: 5px;
                    ">ОБНОВИТЬ СТРАНИЦУ</button>
                `;
                document.getElementById('game-container').appendChild(errorDiv);
            });
        });
    </script>
</body>
</html>
